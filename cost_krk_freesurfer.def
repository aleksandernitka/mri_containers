# Generated by Neurodocker and Reproenv.
# configured by Aleksander Nitka

Bootstrap: docker
From: ubuntu:20.04

%environment
export OS="Linux"
export PATH="/opt/freesurfer-7.2.0/bin:/opt/freesurfer-7.2.0/fsfast/bin:/opt/freesurfer-7.2.0/tktools:/opt/freesurfer-7.2.0/mni/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
export FREESURFER_HOME="/opt/freesurfer-7.2.0"
export FREESURFER="/opt/freesurfer-7.2.0"
export SUBJECTS_DIR="/opt/freesurfer-7.2.0/subjects"
export LOCAL_DIR="/opt/freesurfer-7.2.0/local"
export FSFAST_HOME="/opt/freesurfer-7.2.0/fsfast"
export FMRI_ANALYSIS_DIR="/opt/freesurfer-7.2.0/fsfast"
export FUNCTIONALS_DIR="/opt/freesurfer-7.2.0/sessions"
export FS_OVERRIDE="0"
export FIX_VERTEX_AREA=""
export FSF_OUTPUT_FORMAT="nii.gz# mni env requirements"
export MINC_BIN_DIR="/opt/freesurfer-7.2.0/mni/bin"
export MINC_LIB_DIR="/opt/freesurfer-7.2.0/mni/lib"
export MNI_DIR="/opt/freesurfer-7.2.0/mni"
export MNI_DATAPATH="/opt/freesurfer-7.2.0/mni/data"
export MNI_PERL5LIB="/opt/freesurfer-7.2.0/mni/share/perl5"
export PERL5LIB="/opt/freesurfer-7.2.0/mni/share/perl5"

%post
apt-get update -qq
apt-get install -y -q --no-install-recommends \
    bc \
    ca-certificates \
    curl \
    libgomp1 \
    libxmu6 \
    libxt6 \
    perl \
    tcsh \
    vim \
    nano \
    parallel
rm -rf /var/lib/apt/lists/*
echo "Downloading FreeSurfer ..."
mkdir -p /opt/freesurfer-7.2.0
curl -fL https://surfer.nmr.mgh.harvard.edu/pub/dist/freesurfer/7.2.0/freesurfer-linux-centos6_x86_64-7.2.0.tar.gz \
| tar -xz -C /opt/freesurfer-7.2.0 --owner root --group root --no-same-owner --strip-components 1 \
  --exclude='average/mult-comp-cor' \
  --exclude='lib/cuda' \
  --exclude='lib/qt' \
  --exclude='subjects/V1_average' \
  --exclude='subjects/bert' \
  --exclude='subjects/cvs_avg35' \
  --exclude='subjects/cvs_avg35_inMNI152' \
  --exclude='subjects/fsaverage3' \
  --exclude='subjects/fsaverage4' \
  --exclude='subjects/fsaverage5' \
  --exclude='subjects/fsaverage6' \
  --exclude='subjects/fsaverage_sym' \
  --exclude='trctrain'

# Install miniconda.
export PATH="/opt/miniconda-latest/bin:$PATH"
echo "Downloading Miniconda installer ..."
conda_installer="/tmp/miniconda.sh"
curl -fsSL -o "$conda_installer" https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash "$conda_installer" -b -p /opt/miniconda-latest
rm -f "$conda_installer"
conda update -yq -nbase conda
# Prefer packages in conda-forge
conda config --system --prepend channels conda-forge
# Packages in lower-priority channels not considered if a package with the same
# name exists in a higher priority channel. Can dramatically speed up installations.
# Conda recommends this as a default
# https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-channels.html
conda config --set channel_priority strict
conda config --system --set auto_update_conda false
conda config --system --set show_channel_urls true
# Enable `conda activate`
conda init bash
# Clean up
sync && conda clean --all --yes && sync
rm -rf ~/.cache/pip/*

# some more ls aliases
alias ll='ls -alF'
alias la='ls -A'
alias l='ls -CF'

# install tensorflow
# required by some of the more recent fs parcelation methods
pip install --upgrade pip
pip install tensorflow==2.8

%help
For replicability, all required software were installed with particular version number. Freesurfer v. 7.2.0 and Tensorflow v. 2.8. 

%runscript
bash /opt/freesurfer-7.2.0/SetUpFreeSurfer.sh
